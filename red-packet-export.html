<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢åŒ…å£ä»¤å·¥å…· - è‰¾å…œå…œå„¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">ğŸ§§ çº¢åŒ…å£ä»¤åŠ©åŠ›å·¥å…·</h1>
            <p class="mt-2 text-gray-500">åŒæ­¥åŠ©åŠ›å£ä»¤ï¼Œå¤§å®¶ä¸€èµ·é¢†ç¦åˆ©</p>
        </header>

        <!-- æäº¤è¡¨å• -->
        <section class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <span class="text-xl">âœï¸</span> å‘å¸ƒæ–°å£ä»¤
            </h2>
            <div class="space-y-4">
                <textarea id="content" placeholder="ç²˜è´´çº¢åŒ…å£ä»¤å†…å®¹..." class="w-full h-32 p-4 rounded-2xl bg-gray-50 border-none focus:ring-2 focus:ring-blue-500 transition-all resize-none text-gray-700" required></textarea>
                <div class="flex flex-col md:flex-row gap-4">
                    <input id="creator" type="text" placeholder="ä½ çš„æ˜µç§°" value="è‰¾å…œå…œå„¿" class="flex-1 p-3 rounded-xl bg-gray-50 border-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <button id="submitBtn" onclick="submitPacket()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 active:scale-95 transition-all shadow-lg shadow-blue-200 disabled:opacity-50">
                        å‘å¸ƒåŠ©åŠ›
                    </button>
                </div>
            </div>
        </section>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
            <div class="relative w-full md:w-64">
                <input id="search" oninput="handleSearch()" type="text" placeholder="æœç´¢å†…å®¹æˆ–å‘å¸ƒè€…..." class="w-full pl-10 pr-4 py-2 rounded-xl bg-white border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
            </div>
            <div class="flex bg-white rounded-xl p-1 border border-gray-100 shadow-sm">
                <button onclick="setFilter('active')" id="filter-active" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white">åŠ©æ‰‹ä¸­</button>
                <button onclick="setFilter('all')" id="filter-all" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-gray-500 hover:bg-gray-50">å…¨éƒ¨</button>
            </div>
        </div>

        <!-- å£ä»¤åˆ—è¡¨ -->
        <div id="packetList" class="grid gap-4 md:grid-cols-2">
            <div class="col-span-full py-12 text-center text-gray-400">æ­£åœ¨åŠ è½½å£ä»¤...</div>
        </div>

        <footer class="mt-12 py-8 border-t border-gray-200 text-center text-sm text-gray-500">
            <p>Â© 2026 è‰¾å…œå…œå„¿ ç‰ˆæƒæ‰€æœ‰ Â· AI365</p>
            <p class="mt-2 flex justify-center gap-4">
                <a href="index-export.html" class="hover:text-blue-600">è¿”å›ä¸»é¡µ</a>
                <span>|</span>
                <a href="#" onclick="copyQQ()" class="hover:text-blue-600">å®˜æ–¹QQç¾¤: 857023577</a>
            </p>
        </footer>
    </div>

    <div id="toast" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="toastContent" class="bg-black/75 text-white px-6 py-3 rounded-2xl shadow-lg backdrop-blur-md text-sm font-medium animate-fade-in-down"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bmmtcrqvikvunvpsjjcx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbXRjcnF2aWt2dW52cHNqamN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NDY4ODUsImV4cCI6MjA4MzUyMjg4NX0.RkaxCuNYHFtS7uDCsIpbZrQ2mheShQNkAHfXyxQGxK0';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let packets = [];
        let filter = 'active';
        let searchTerm = '';

        async function fetchPackets() {
            const listEl = document.getElementById('packetList');
            let query = _supabase.from('red_packets').select('*').order('created_at', { ascending: false });
            
            if (filter === 'active') {
                query = query.gt('remaining_copies', 0);
            }

            const { data, error } = await query;
            if (error) {
                console.error('Fetch error:', error);
                return;
            }
            packets = data;
            renderPackets();
        }

        function renderPackets() {
            const listEl = document.getElementById('packetList');
            const filtered = packets.filter(p => 
                p.content.toLowerCase().includes(searchTerm.toLowerCase()) || 
                p.creator_name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="col-span-full py-12 text-center text-gray-400">æš‚æ— ç›¸å…³å£ä»¤</div>';
                return;
            }

            listEl.innerHTML = filtered.map(p => `
                <div class="group bg-white rounded-2xl p-5 border border-gray-100 hover:shadow-xl hover:shadow-gray-200/50 transition-all duration-300">
                    <div class="flex items-center gap-3 mb-4">
                        <img src="${p.creator_avatar || 'https://api.dicebear.com/7.x/identicon/svg?seed=' + p.creator_name}" class="w-10 h-10 rounded-full bg-gray-50 border border-gray-100 object-cover">
                        <div>
                            <div class="font-semibold text-gray-900 text-sm">${p.creator_name}</div>
                            <div class="text-[10px] text-gray-400">${new Date(p.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-3 text-gray-700 text-sm break-all font-mono mb-4 leading-relaxed line-clamp-4">
                        ${p.content}
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1.5 px-2.5 py-1 bg-amber-50 rounded-lg text-amber-700 text-[11px] font-medium border border-amber-100">
                            <span>ğŸ”¥</span> å‰©ä½™ ${p.remaining_copies} æ¬¡
                        </div>
                        <button onclick="copyPacket('${p.id}', '${p.content.replace(/'/g, "\\'")}')" class="px-4 py-1.5 bg-gray-900 text-white text-xs rounded-lg hover:bg-black transition-colors">
                            å¤åˆ¶å£ä»¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function submitPacket() {
            const content = document.getElementById('content').value.trim();
            const creator = document.getElementById('creator').value.trim();
            const btn = document.getElementById('submitBtn');

            if (!content || !creator) {
                showToast('è¯·å¡«å†™å†…å®¹å’Œæ˜µç§°');
                return;
            }

            btn.disabled = true;
            btn.innerText = 'å‘å¸ƒä¸­...';

            const { error } = await _supabase.from('red_packets').insert([
                { 
                    content, 
                    creator_name: creator, 
                    creator_avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=' + creator,
                    remaining_copies: 3
                }
            ]);

            if (error) {
                showToast('å‘å¸ƒå¤±è´¥: ' + error.message);
            } else {
                showToast('ğŸ‰ å‘å¸ƒæˆåŠŸï¼');
                document.getElementById('content').value = '';
                fetchPackets();
            }

            btn.disabled = false;
            btn.innerText = 'å‘å¸ƒåŠ©åŠ›';
        }

        async function copyPacket(id, content) {
            try {
                await navigator.clipboard.writeText(content);
                showToast('âœ… å£ä»¤å·²å¤åˆ¶ï¼Œå¿«å»åŠ©åŠ›å§');
                
                // å‡å°‘æ¬¡æ•°
                await _supabase.rpc('decrement_packet_copies', { packet_id: id });
                fetchPackets();
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
            }
        }

        function handleSearch() {
            searchTerm = document.getElementById('search').value;
            renderPackets();
        }

        function setFilter(f) {
            filter = f;
            document.getElementById('filter-active').className = f === 'active' ? 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white' : 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-gray-500 hover:bg-gray-50';
            document.getElementById('filter-all').className = f === 'all' ? 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white' : 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-gray-500 hover:bg-gray-50';
            fetchPackets();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const content = document.getElementById('toastContent');
            content.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2000);
        }

        function copyQQ() {
            navigator.clipboard.writeText('857023577');
            showToast('QQç¾¤å·å·²å¤åˆ¶');
        }

        // åˆå§‹åŒ–
        fetchPackets();
    </script>
</body>
</html>