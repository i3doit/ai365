<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢åŒ…å£ä»¤å·¥å…· - AI365</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', system-ui, -apple-system, sans-serif;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 640px) {
            .packet-card { padding: 1rem; }
            .action-btn { padding: 0.5rem; }
            .action-text { font-size: 0.65rem; }
        }
    </style>
</head>
<body class="bg-gray-50/50 min-h-screen font-sans text-gray-900">
    <!-- Floating Actions -->
    <div class="fixed right-4 bottom-24 flex flex-col gap-3 z-40">
        <button onclick="toggleUsage()" class="w-12 h-12 bg-white/90 backdrop-blur border border-gray-100 rounded-full shadow-lg flex items-center justify-center text-xl hover:bg-gray-50 active:scale-95 transition-all" title="ä½¿ç”¨è¯´æ˜">ğŸ“–</button>
        <button onclick="toggleFeedback()" class="w-12 h-12 bg-white/90 backdrop-blur border border-gray-100 rounded-full shadow-lg flex items-center justify-center text-xl hover:bg-gray-50 active:scale-95 transition-all" title="æäº¤åé¦ˆ">ğŸ’¬</button>
    </div>

    <!-- Usage Modal -->
    <div id="usageModal" class="fixed inset-0 z-50 flex items-center justify-center hidden p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleUsage()"></div>
        <div class="relative bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">ä½¿ç”¨è¯´æ˜ ğŸ“–</h3>
                <button onclick="toggleUsage()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div class="space-y-4 text-sm text-gray-600 leading-relaxed">
                <div class="p-4 bg-orange-50 rounded-2xl border border-orange-100">
                    <p class="font-bold text-orange-800 mb-2">å¦‚ä½•å‘å¸ƒï¼Ÿ</p>
                    <p>å¡«å†™æ˜µç§°ã€è®¾ç½®åŠ©åŠ›æ¬¡æ•°ï¼ˆé»˜è®¤3æ¬¡ï¼‰ï¼Œç²˜è´´ä½ çš„çº¢åŒ…å£ä»¤æˆ–é“¾æ¥ç‚¹å‡»â€œå‘å¸ƒåˆ†äº«â€å³å¯ã€‚</p>
                </div>
                <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                    <p class="font-bold text-blue-800 mb-2">å¦‚ä½•äº’åŠ©ï¼Ÿ</p>
                    <p>ç‚¹å‡»ä»–äººå¡ç‰‡çš„â€œå¤åˆ¶å£ä»¤â€ï¼Œå»å¯¹åº”çš„ App ä½¿ç”¨ã€‚å¤åˆ¶æˆåŠŸåï¼Œå¯¹æ–¹çš„åŠ©åŠ›æ¬¡æ•°ä¼šå‡1ã€‚</p>
                </div>
                <div class="p-4 bg-green-50 rounded-2xl border border-green-100">
                    <p class="font-bold text-green-800 mb-2">æ¸©é¦¨æç¤º</p>
                    <ul class="list-disc ml-4 space-y-1">
                        <li>ä»…å±•ç¤ºå½“å¤©çš„å£ä»¤ï¼Œè¿‡æœŸè‡ªåŠ¨å¤±æ•ˆã€‚</li>
                        <li>è‡ªå·±ç‚¹å‡»è‡ªå·±å‘å¸ƒçš„å£ä»¤ä¸æ‰£å‡æ¬¡æ•°ã€‚</li>
                        <li>ç‚¹å‡»ç”¨æˆ·å¤´åƒå¯ä»¥è¿›å…¥è¯¥ç”¨æˆ·çš„ä¸»é¡µæŸ¥çœ‹æ›´å¤šã€‚</li>
                    </ul>
                </div>
            </div>
            <button onclick="toggleUsage()" class="w-full mt-6 py-3 bg-gray-900 text-white rounded-xl font-medium">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="fixed inset-0 z-50 flex items-center justify-center hidden p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleFeedback()"></div>
        <div class="relative bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">é—®é¢˜åé¦ˆ ğŸ’¬</h3>
                <button onclick="toggleFeedback()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-gray-500">æ‚¨çš„åé¦ˆæ˜¯æˆ‘ä»¬è¿›æ­¥çš„åŠ¨åŠ›ï¼Œè¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜ã€‚</p>
                <textarea id="feedbackContent" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-sm text-gray-900 h-32 focus:ring-2 focus:ring-blue-500/20 resize-none" placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„åé¦ˆå†…å®¹..."></textarea>
                <input id="feedbackContact" type="text" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-sm text-gray-900 focus:ring-2 focus:ring-blue-500/20" placeholder="è”ç³»æ–¹å¼ï¼ˆQQ/å¾®ä¿¡/é‚®ç®±ï¼Œé€‰å¡«ï¼‰">
                <button id="feedbackSubmitBtn" onclick="submitFeedback()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-medium shadow-lg shadow-blue-500/20 hover:bg-blue-700 transition-all">æäº¤åé¦ˆ</button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-2xl mx-auto px-4 py-8">
        <!-- User Page Header -->
        <div id="userHeader" class="hidden mb-6 flex items-center justify-between bg-white/80 backdrop-blur p-4 rounded-2xl border border-gray-100 shadow-sm animate-slide-in">
            <div class="flex items-center gap-3">
                <button onclick="handleBackFromUser()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="text-xl">â†</span>
                </button>
                <div>
                    <h2 id="userPageTitle" class="font-bold text-gray-900">çš„ç”¨æˆ·ä¸»é¡µ</h2>
                    <p class="text-xs text-gray-400">æ˜¾ç¤ºè¯¥ç”¨æˆ·æäº¤çš„æ‰€æœ‰å£ä»¤</p>
                </div>
            </div>
            <button onclick="handleBackFromUser()" class="text-sm text-blue-500 font-medium">è¿”å›åˆ—è¡¨</button>
        </div>

        <!-- Header -->
        <header id="mainHeader" class="text-center mb-10">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-red-500 to-orange-500 mb-2">
                çº¢åŒ…å£ä»¤/é“¾æ¥åˆ†äº«
            </h1>
            <p class="text-gray-500 text-sm">åˆ†äº«ä½ çš„ç¦åˆ©ï¼Œä¼ é€’å¥½è¿</p>
        </header>

        <!-- Create Card -->
        <section id="createCard" class="bg-white rounded-3xl shadow-lg shadow-gray-100/50 border border-white/50 backdrop-blur-xl p-6 mb-8 transition-transform hover:scale-[1.01] duration-300">
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1 ml-1">ä½ çš„æ˜µç§°</label>
                        <div class="relative">
                            <input id="creatorName" type="text" value="è‰¾å…œå…œå„¿" onclick="this.value=''" onblur="if(!this.value)this.value='è‰¾å…œå…œå„¿'" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-red-500/20 focus:bg-white transition-all" placeholder="è‰¾å…œå…œå„¿">
                            <button onclick="document.getElementById('creatorName').value=''; document.getElementById('creatorName').focus();" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">âœ•</button>
                        </div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-600 mb-1 ml-1 flex justify-between">
                            <span>åŠ©åŠ›æ¬¡æ•°</span>
                            <span class="text-xs text-gray-400 font-normal">é«˜æ•ˆé¢†çº¢åŒ…ï¼Œå¯å¡«åŠ©åŠ›æ¬¡æ•°</span>
                        </label>
                        <div class="relative">
                            <input id="totalCopies" type="number" value="3" min="1" max="100" 
                                   onclick="this.value=''" 
                                   onblur="if(!this.value || this.value<1)this.value='3'"
                                   class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-red-500/20 focus:bg-white transition-all">
                            <button onclick="document.getElementById('totalCopies').value='3'; document.getElementById('totalCopies').focus();" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">âœ•</button>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1 ml-1">å¤´åƒé“¾æ¥ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="relative">
                        <input id="avatarUrl" type="text" onclick="this.value=''" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-red-500/20 focus:bg-white transition-all" placeholder="ç²˜è´´URLæˆ–ä½¿ç”¨é»˜è®¤">
                        <button onclick="document.getElementById('avatarUrl').value=''; document.getElementById('avatarUrl').focus();" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">âœ•</button>
                    </div>
                    <div class="mt-3 flex items-center gap-2 overflow-x-auto pb-2 no-scrollbar" id="avatarList">
                        <!-- Avatars will be injected here -->
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1 ml-1">å£ä»¤æˆ–é“¾æ¥</label>
                    <div class="relative">
                        <textarea id="newContent" onclick="this.value=''" onfocus="handleAutoPaste(this)" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 text-gray-900 placeholder-gray-400 focus:ring-2 focus:ring-red-500/20 focus:bg-white transition-all resize-none h-32" placeholder="ç²˜è´´ä½ çš„çº¢åŒ…å£ä»¤æˆ–é“¾æ¥..."></textarea>
                        <button onclick="document.getElementById('newContent').value=''; document.getElementById('newContent').focus();" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">âœ•</button>
                    </div>
                </div>

                <button onclick="handleCreate()" id="submitBtn" class="w-full bg-gradient-to-r from-red-500 to-orange-500 text-white font-semibold py-3.5 rounded-xl shadow-lg shadow-orange-500/20 hover:shadow-orange-500/30 active:scale-[0.98] transition-all duration-200">
                    å‘å¸ƒåˆ†äº«
                </button>
            </div>
        </section>

        <!-- Filters -->
        <div class="sticky top-0 z-20 bg-white/70 backdrop-blur border-b border-gray-100 -mx-4 px-4 py-3 mb-6">
            <div class="relative mb-3">
                <input id="searchTerm" oninput="handleSearch()" type="text" class="w-full bg-white/80 border border-gray-200 rounded-2xl px-5 py-3 pl-11 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm" placeholder="æœç´¢æ˜µç§°æˆ–å£ä»¤...">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span>
                <button onclick="document.getElementById('searchTerm').value=''; handleSearch();" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div class="flex items-center gap-2 bg-white/70 border border-gray-200 rounded-xl p-1 w-fit">
                <button onclick="setFilter('all')" id="btn-all" class="px-3 py-1.5 text-xs rounded-lg text-gray-700 hover:bg-white transition-all">å…¨éƒ¨</button>
                <button onclick="setFilter('active')" id="btn-active" class="px-3 py-1.5 text-xs rounded-lg bg-gray-900 text-white transition-all">è¿›è¡Œä¸­</button>
                <button onclick="setFilter('completed')" id="btn-completed" class="px-3 py-1.5 text-xs rounded-lg text-gray-700 hover:bg-white transition-all">å·²å®Œæˆ</button>
                <button onclick="setFilter('expired')" id="btn-expired" class="px-3 py-1.5 text-xs rounded-lg text-gray-700 hover:bg-white transition-all">å·²è¿‡æœŸ</button>
            </div>
        </div>

        <!-- List -->
        <div id="packetList" class="space-y-4 min-h-[300px]">
            <div class="text-center py-10 text-gray-400">åŠ è½½ä¸­...</div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 py-10 border-t border-gray-100 text-center space-y-6">
            <div class="flex flex-col items-center gap-4">
                <div class="flex flex-wrap justify-center gap-x-6 gap-y-3 text-sm font-medium">
                    <a href="https://mp.weixin.qq.com/s/EpghdXSl4NqOD5mwu3DWXQ" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors">æŠ€æœ¯æ”¯æŒï¼šè‰¾å…œå…œå„¿</a>
                    <a href="https://t.zsxq.com/XNHXs" target="_blank" class="text-gray-600 hover:text-blue-600 transition-colors">DeepSeek å®æˆ˜ææ•ˆèµšå°é’±</a>
                    <a href="https://t.zsxq.com/uqG2N" target="_blank" class="text-gray-600 hover:text-blue-600 transition-colors">AI ç¼–ç¨‹åšäº§å“</a>
                    <a href="https://t.zsxq.com/FhQcu" target="_blank" class="text-gray-600 hover:text-blue-600 transition-colors">æ›´å¤šå·¥å…·</a>
                </div>
                
                <button onclick="navigator.clipboard.writeText('857023577'); showToast('QQç¾¤å·å·²å¤åˆ¶ï¼š857023577')" 
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-xs font-semibold hover:bg-blue-100 transition-all border border-blue-100">
                    <span>ğŸ’¬ AI ææ•ˆå·¥å…·å®˜æ–¹ QQ ç¾¤ï¼š857023577</span>
                    <span class="text-[10px] bg-blue-200/50 px-1.5 py-0.5 rounded">ç‚¹å‡»å¤åˆ¶</span>
                </button>
            </div>

            <div class="text-[11px] text-gray-400 space-y-1">
                <p id="copyrightText"></p>
                <div class="flex justify-center gap-3 opacity-60">
                    <a href="https://dkfile.com" target="_blank" class="hover:underline">DKFile.com</a>
                    <a href="https://dkfile.xyz" target="_blank" class="hover:underline">DKFile.xyz</a>
                    <a href="https://dkfile.istester.com" target="_blank" class="hover:underline">DKFile.istester.com</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal for Records -->
    <div id="recordsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm hidden animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-gray-50/50">
                <h3 class="font-bold text-gray-900 flex items-center gap-2">
                    <span class="text-xl">ğŸ¤</span> åŠ©åŠ›è®°å½•
                </h3>
                <button onclick="closeRecords()" class="p-2 hover:bg-gray-200 rounded-full transition-colors">âœ•</button>
            </div>
            <div id="recordsList" class="max-h-[60vh] overflow-y-auto p-4 space-y-3">
                <!-- Records will be injected here -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300">
        <div id="toastMsg" class="bg-black/75 text-white px-6 py-3 rounded-2xl shadow-lg backdrop-blur-md text-sm font-medium"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bmmtcrqvikvunvpsjjcx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbXRjcnF2aWt2dW52cHNqamN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NDY4ODUsImV4cCI6MjA4MzUyMjg4NX0.RkaxCuNYHFtS7uDCsIpbZrQ2mheShQNkAHfXyxQGxK0';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { 
            db: { schema: 'api' },
            global: { headers: { 'x-client-info': 'red-packet-tool' } }
        });

        // å°è¯•é€šè¿‡ OPTIONS è¯·æ±‚è§¦å‘åˆ·æ–° (éƒ¨åˆ† PostgREST ç‰ˆæœ¬ç‰¹æ€§)
        async function forceRefreshSchema() {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/red_packets`, {
                    method: 'OPTIONS',
                    headers: { 'apikey': SUPABASE_KEY }
                });
            } catch (e) {}
        }
        forceRefreshSchema();

        // åˆ·æ–°ç¼“å­˜æé†’ï¼šå¦‚æœé‡åˆ° PGRST204 é”™è¯¯ï¼ˆæ‰¾ä¸åˆ° client_id åˆ—ï¼‰ï¼Œ
        // æ˜¯å› ä¸ºæ•°æ®åº“ Schema å˜æ›´åç¼“å­˜æœªåŒæ­¥ã€‚
        // è¯·åœ¨ Supabase SQL Editor ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ·æ–°ï¼š
        // NOTIFY pgrst, 'reload schema';

        const DEFAULT_AVATARS = [
            'https://dkfile.net/uploads/avatars/avatar_1037_2b899c87.jpeg',
            'https://profile-avatar.csdnimg.cn/22f8b0128b694047beb93057ddc0d7cc_kq8819.jpg!1',
            'https://api.dicebear.com/7.x/identicon/svg?seed=Felix',
            'https://api.dicebear.com/7.x/identicon/svg?seed=Aneka',
            'https://api.dicebear.com/7.x/identicon/svg?seed=Zoe'
        ];

        let packets = [];
        let filterStatus = 'active';
        let searchTerm = '';
        let userClientId = null;
        const clientId = localStorage.getItem('rp_client_id') || Math.random().toString(36).slice(2, 12);
        localStorage.setItem('rp_client_id', clientId);

        function initCopyright() {
            const year = new Date().getFullYear();
            const yearStr = year > 2026 ? `2026-${year}` : '2026';
            document.getElementById('copyrightText').innerText = `Â© ${yearStr} è‰¾å…œå…œå„¿ ç‰ˆæƒæ‰€æœ‰ Â· AI365`;
        }

        function initAvatars() {
            const list = document.getElementById('avatarList');
            list.innerHTML = DEFAULT_AVATARS.map(url => `
                <button type="button" onclick="setAvatar('${url}')" class="flex-shrink-0 w-10 h-10 rounded-full border border-gray-200 overflow-hidden hover:ring-2 hover:ring-red-500 transition-all">
                    <img src="${url}" class="w-full h-full object-cover">
                </button>
            `).join('');
        }

        function setAvatar(url) {
            document.getElementById('avatarUrl').value = url;
            showToast('å·²é€‰æ‹©å¤´åƒ');
        }

        async function fetchPackets() {
            const listEl = document.getElementById('packetList');
            try {
                let query = _supabase.from('red_packets').select('*').order('created_at', { ascending: false });

                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0).toISOString();

                if (userClientId) {
                    query = query.eq('client_id', userClientId);
                } else {
                    const now = new Date();
                    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0).toISOString();
                    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999).toISOString();

                    if (filterStatus === 'active') {
                        // ä¼˜å…ˆæ˜¾ç¤ºå½“å¤©çš„è¿›è¡Œä¸­æ•°æ®
                        const { data: todayData } = await _supabase.from('red_packets')
                            .select('id')
                            .eq('status', 'active')
                            .gt('remaining_copies', 0)
                            .gte('created_at', start)
                            .lte('created_at', end)
                            .limit(1);
                        
                        if (todayData && todayData.length > 0) {
                            query = query.eq('status', 'active').gt('remaining_copies', 0).gte('created_at', start).lte('created_at', end);
                        } else {
                            // è‹¥å½“å¤©æ— æ•°æ®ï¼Œå±•ç¤ºæœ€åä¸€å¤©æœ‰è¿›è¡Œä¸­æ•°æ®çš„æ—¥æœŸ
                            const { data: lastPacket } = await _supabase.from('red_packets')
                                .select('created_at')
                                .eq('status', 'active')
                                .gt('remaining_copies', 0)
                                .order('created_at', { ascending: false })
                                .limit(1);
                            
                            if (lastPacket?.[0]) {
                                const lastDate = new Date(lastPacket[0].created_at);
                                const lStart = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate(), 0, 0, 0, 0).toISOString();
                                const lEnd = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate(), 23, 59, 59, 999).toISOString();
                                query = query.eq('status', 'active').gt('remaining_copies', 0).gte('created_at', lStart).lte('created_at', lEnd);
                            } else {
                                query = query.eq('status', 'active').gt('remaining_copies', 0);
                            }
                        }
                    } else if (filterStatus === 'completed') {
                        query = query.eq('remaining_copies', 0);
                    } else if (filterStatus === 'expired') {
                        query = query.gt('remaining_copies', 0).lt('created_at', start);
                    }
                }

                const { data, error } = await query;
                if (error) throw error;
                packets = data || [];
                renderPackets();
            } catch (err) {
                console.error(err);
                listEl.innerHTML = '<div class="text-center py-10 text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }

        function renderPackets() {
            const listEl = document.getElementById('packetList');
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);

            const filtered = packets.filter(p => 
                p.content.toLowerCase().includes(searchTerm.toLowerCase()) || 
                p.creator_name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="text-center py-12 bg-white rounded-3xl border border-dashed border-gray-200 text-gray-400">æš‚æ— æ•°æ®</div>';
                return;
            }

            listEl.innerHTML = filtered.map(p => {
                const isExpired = p.remaining_copies > 0 && new Date(p.created_at) < todayStart;
                const isCompleted = p.remaining_copies === 0;
                const isDisabled = isExpired || isCompleted;
                const statusClass = isExpired ? 'opacity-50 grayscale' : (isCompleted ? 'opacity-60 grayscale-[0.5]' : '');
                
                return `
                <div class="group relative bg-white rounded-2xl p-5 shadow-sm border border-gray-100 transition-all hover:shadow-md ${statusClass}">
                    <div class="flex items-start gap-4">
                        <img src="${p.creator_avatar || DEFAULT_AVATARS[0]}" onclick="handleUserClick('${p.client_id}', '${p.creator_name}')" class="w-10 h-10 rounded-full object-cover border border-gray-100 cursor-pointer hover:ring-2 hover:ring-red-500 transition-all">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div onclick="handleUserClick('${p.client_id}', '${p.creator_name}')" class="cursor-pointer">
                                    <h3 class="text-sm font-semibold text-gray-900 group-hover:text-red-500">${p.creator_name}</h3>
                                    <p class="text-[10px] text-gray-400 mt-0.5">${new Date(p.created_at).toLocaleString()}</p>
                                </div>
                                <div class="flex flex-col items-end gap-1">
                                    <div class="px-2 py-1 rounded-lg text-[10px] font-medium ${isExpired ? 'bg-gray-100 text-gray-400' : (p.remaining_copies > 0 ? 'bg-green-50 text-green-700' : 'bg-gray-100 text-gray-500')}">
                                        ${isExpired ? 'å·²è¿‡æœŸ' : (p.remaining_copies > 0 ? 'å‰©ä½™ ' + p.remaining_copies + ' æ¬¡' : 'å·²å®Œæˆ')}
                                    </div>
                                    ${p.client_id === clientId ? `<button onclick="showRecords('${p.id}')" class="text-[10px] text-blue-500 hover:underline">æŸ¥çœ‹åŠ©åŠ›è®°å½•</button>` : ''}
                                </div>
                            </div>
                            <div class="mt-3 bg-gray-50 rounded-xl p-3 text-gray-700 text-sm break-all font-mono leading-relaxed">
                                ${p.content.replace(/</g, '&lt;')}
                            </div>
                            <div class="mt-4 flex justify-around gap-2 pt-4 border-t border-gray-50">
                                <button onclick="${isDisabled ? `showToast('è¯¥å£ä»¤${isExpired ? 'å·²è¿‡æœŸ' : 'å·²é¢†å®Œ'}ï¼Œè¯·ä½¿ç”¨ä»Šå¤©æœ€æ–°çš„å£ä»¤å§')` : `handleCopy('${p.id}', '${p.client_id}', '${p.creator_name.replace(/'/g, "\\'")}', '${(p.creator_avatar || '').replace(/'/g, "\\'")}', \`${p.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)`}" 
                                        class="action-btn flex flex-col items-center gap-1 group/btn ${isDisabled ? 'cursor-not-allowed' : ''}">
                                    <div class="w-10 h-10 flex items-center justify-center bg-blue-50 text-blue-600 rounded-full ${isDisabled ? 'grayscale opacity-50' : 'group-hover/btn:bg-blue-600 group-hover/btn:text-white'} transition-all shadow-sm">
                                        <span class="text-lg">ğŸ“‹</span>
                                    </div>
                                    <span class="action-text text-[10px] text-gray-500 font-medium">å¤åˆ¶å£ä»¤</span>
                                </button>
                                <button onclick="${isDisabled ? `showToast('è¯¥å£ä»¤${isExpired ? 'å·²è¿‡æœŸ' : 'å·²é¢†å®Œ'}ï¼Œè¯·ä½¿ç”¨ä»Šå¤©æœ€æ–°çš„å£ä»¤å§')` : `handleShare('${p.id}', '${p.creator_name}', '${p.remaining_copies}', \`${p.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)`}" 
                                        class="action-btn flex flex-col items-center gap-1 group/btn ${isDisabled ? 'cursor-not-allowed' : ''}">
                                    <div class="w-10 h-10 flex items-center justify-center bg-pink-50 text-pink-600 rounded-full ${isDisabled ? 'grayscale opacity-50' : 'group-hover/btn:bg-pink-600 group-hover/btn:text-white'} transition-all shadow-sm">
                                        <span class="text-lg">ğŸ”—</span>
                                    </div>
                                    <span class="action-text text-[10px] text-gray-500 font-medium">åŠ©åŠ›åˆ†äº«</span>
                                </button>
                                <button onclick="handleDownload('${p.id}', '${p.creator_name}')" class="action-btn flex flex-col items-center gap-1 group/btn">
                                    <div class="w-10 h-10 flex items-center justify-center bg-green-50 text-green-600 rounded-full group-hover/btn:bg-green-600 group-hover/btn:text-white transition-all shadow-sm">
                                        <span class="text-lg">â¬‡ï¸</span>
                                    </div>
                                    <span class="action-text text-[10px] text-gray-500 font-medium">ä¸‹è½½å¡ç‰‡</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function handleCreate(e) {
            if (e && e.preventDefault) e.preventDefault();
            const content = document.getElementById('newContent').value.trim();
            const creator = document.getElementById('creatorName').value.trim();
            const avatar = document.getElementById('avatarUrl').value.trim();
            const copies = parseInt(document.getElementById('totalCopies').value) || 0;

            if (!content) return showToast('è¯·è¾“å…¥å£ä»¤æˆ–é“¾æ¥');
            if (!creator) return showToast('è¯·è¾“å…¥æ˜µç§°');
            if (copies < 1) return showToast('åŠ©åŠ›æ¬¡æ•°å¿…é¡»å¤§äº0');

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = 'å‘å¸ƒä¸­...';

            try {
                const finalAvatar = avatar || DEFAULT_AVATARS[0];
                const { error } = await _supabase.from('red_packets').insert([{
                    content: content,
                    creator_name: creator,
                    creator_avatar: finalAvatar,
                    remaining_copies: copies,
                    total_copies: copies,
                    client_id: clientId,
                    status: 'active'
                }]).select(); // ä½¿ç”¨ select() å¼ºåˆ¶è¿”å›æ–°æ’å…¥çš„æ•°æ®ï¼Œæœ‰æ—¶èƒ½ç»•è¿‡è¿‡æ—¶çš„ç¼“å­˜æ˜ å°„

                if (error) {
                    console.error('Supabase Error:', error);
                    if (error.code === 'PGRST204') {
                        showToast('æ•°æ®åº“ç¼“å­˜æœªåŒæ­¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜è¿è¡Œï¼šNOTIFY pgrst, \'reload schema\';');
                    } else {
                        throw error;
                    }
                } else {
                    showToast('å‘å¸ƒæˆåŠŸï¼');
                    document.getElementById('newContent').value = '';
                    if (filterStatus === 'completed' || filterStatus === 'expired') {
                        setFilter('active');
                    } else {
                        fetchPackets();
                    }
                }
            } catch (err) {
                console.error(err);
                showToast('å‘å¸ƒå¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œå¼‚å¸¸'));
            } finally {
                btn.disabled = false;
                btn.innerText = 'å‘å¸ƒåˆ†äº«';
            }
        }

        async function handleCopy(id, creatorId, creatorName, creatorAvatar, content) {
            try {
                const isOwner = creatorId === clientId;

                if (!isOwner) {
                    const { data: existed, error: checkError } = await _supabase
                        .from('copy_records')
                        .select('id')
                        .eq('copier_client_id', clientId)
                        .eq('creator_client_id', creatorId)
                        .limit(1);

                    if (!checkError && existed && existed.length > 0) {
                        showToast('åŒä¸€ä¸ªç”¨æˆ·å¤šä¸ªå£ä»¤åªéœ€é€‰ä¸€ä¸ªï¼Œä½ å·²å¸®TAåŠ©åŠ›ï¼Œå»é€‰æ‹©å…¶ä»–äººåŠ©åŠ›é¢†çº¢åŒ…å§');
                        return;
                    }
                }

                await navigator.clipboard.writeText(content);

                const copiedKey = `copied_packets`;
                const copiedList = JSON.parse(localStorage.getItem(copiedKey) || '[]');

                if (!isOwner && copiedList.includes(id)) {
                    showToast('æ‚¨å·²é¢†å–è¿‡è¯¥çº¢åŒ…ï¼Œç•™ç»™å…¶ä»–äººå§ï¼');
                    return;
                }

                const { data: packet } = await _supabase
                    .from('red_packets')
                    .select('remaining_copies, creator_name, creator_avatar, client_id')
                    .eq('id', id)
                    .single();

                const finalCreatorName = (packet && packet.creator_name) || creatorName || 'åŒ¿åç”¨æˆ·';
                const finalCreatorAvatar = (packet && packet.creator_avatar) || creatorAvatar || DEFAULT_AVATARS[0];

                const selfClick = isOwner;
                let newCount = packet ? packet.remaining_copies : 0;

                if (!selfClick && packet && packet.remaining_copies > 0) {
                    newCount = packet.remaining_copies - 1;
                    await _supabase.from('red_packets').update({ 
                        remaining_copies: newCount,
                        status: newCount === 0 ? 'completed' : 'active'
                    }).eq('id', id);
                }
                
                await _supabase.from('copy_records').insert([{
                    red_packet_id: id,
                    copier_name: document.getElementById('creatorName').value || 'åŒ¿åç”¨æˆ·',
                    copier_client_id: clientId,
                    copier_avatar: document.getElementById('avatarUrl').value || DEFAULT_AVATARS[0],
                    creator_client_id: creatorId,
                    creator_name: finalCreatorName,
                    creator_avatar: finalCreatorAvatar,
                    is_self: selfClick
                }]);

                if (!selfClick && packet && packet.remaining_copies > 0) {
                    copiedList.push(id);
                    localStorage.setItem(copiedKey, JSON.stringify(copiedList));
                    fetchPackets();
                }

                if (selfClick) {
                    showToast('å¤åˆ¶æˆåŠŸï¼Œè‡ªå·±æäº¤çš„æ¬¡æ•°ä¸å‡ï¼Œå»åŠ©åŠ›å…¶ä»–å°ä¼™ä¼´å§');
                } else if (packet && packet.remaining_copies > 0) {
                    showToast('å¤åˆ¶æˆåŠŸ');
                } else {
                    showToast('è¯¥çº¢åŒ…å·²è¢«é¢†å®Œ');
                }
            } catch (err) {
                console.error(err);
                showToast('å¤åˆ¶å¤±è´¥');
            }
        }

        async function handleShare(id, name, remaining, content) {
            const url = window.location.href.split('?')[0] + '?id=' + id;
            const shareData = {
                title: 'åŠ©åŠ›é¢†çº¢åŒ…',
                text: `æ¥è‡ªã€${name}ã€‘çš„ç¦åˆ©åˆ†äº«ï¼š\n${content}\nå‰©ä½™åŠ©åŠ›æ¬¡æ•°ï¼š${remaining}\nå¿«æ¥ä¸€èµ·åŠ©åŠ›é¢†ç¦åˆ©å§ï¼`,
                url: url
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // å›é€€æ–¹æ¡ˆï¼šå¤åˆ¶åˆ†äº«æ–‡æ¡ˆ
                    await navigator.clipboard.writeText(`${shareData.text}\né“¾æ¥ï¼š${shareData.url}`);
                    showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåŸç”Ÿåˆ†äº«ï¼Œå·²è‡ªåŠ¨å¤åˆ¶åˆ†äº«æ–‡æ¡ˆ');
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('åˆ†äº«å¤±è´¥');
                }
            }
        }

        async function handleAutoPaste(el) {
            try {
                // å°è¯•ä»å‰ªè´´æ¿è·å–å†…å®¹
                const text = await navigator.clipboard.readText();
                if (text && text.trim() && !el.value) {
                    el.value = text.trim();
                    showToast('å·²è‡ªåŠ¨ä»å‰ªè´´æ¿ç²˜è´´å†…å®¹');
                }
            } catch (err) {
                // å¿½ç•¥æƒé™æ‹’ç»çš„æƒ…å†µ
            }
        }

        function handleDownload(id, name) {
            const url = window.location.href.split('?')[0] + '?id=' + id;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`;
            window.open(qrUrl, '_blank');
            showToast('å·²è·³è½¬åˆ°äºŒç»´ç é¡µé¢');
        }

        function handleUserClick(cid, name) {
            userClientId = cid;
            document.getElementById('userPageTitle').innerText = name + ' çš„ä¸»é¡µ';
            document.getElementById('userHeader').classList.remove('hidden');
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('createCard').classList.add('hidden');
            fetchPackets();
        }

        function handleBackFromUser() {
            userClientId = null;
            document.getElementById('userHeader').classList.add('hidden');
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('createCard').classList.remove('hidden');
            fetchPackets();
        }

        async function showRecords(id) {
            const modal = document.getElementById('recordsModal');
            const list = document.getElementById('recordsList');
            modal.classList.remove('hidden');
            list.innerHTML = '<div class="text-center py-8 text-gray-400">åŠ è½½ä¸­...</div>';

            try {
                const { data, error } = await _supabase.from('copy_records').select('*').eq('red_packet_id', id).order('created_at', { ascending: false });
                if (error) throw error;
                if (!data || data.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">æš‚æ— åŠ©åŠ›è®°å½•</div>';
                } else {
                    list.innerHTML = data.map(rec => `
                        <div onclick="closeRecords(); handleUserClick('${rec.copier_client_id}', '${rec.copier_name}')" class="flex items-center gap-3 p-3 rounded-2xl hover:bg-gray-50 cursor-pointer transition-colors border border-transparent hover:border-gray-100">
                            <img src="${rec.copier_avatar || DEFAULT_AVATARS[0]}" class="w-10 h-10 rounded-full border border-gray-100 w-10 h-10 object-cover">
                            <div class="flex-1">
                                <div class="font-semibold text-sm text-gray-900">
                                    ${rec.copier_name}
                                    ${rec.copier_client_id === clientId ? '<span class="ml-1 px-1.5 py-0.5 text-[10px] rounded bg-blue-50 text-blue-600 align-middle">æˆ‘</span>' : ''}
                                </div>
                                <div class="text-[10px] text-gray-400">${new Date(rec.created_at).toLocaleString()}</div>
                            </div>
                            <div class="text-xs text-blue-500 font-medium">æŸ¥çœ‹ Ta</div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                list.innerHTML = '<div class="text-center py-8 text-red-400">åŠ è½½å¤±è´¥</div>';
            }
        }

        // Feedback Logic
        function toggleFeedback() {
            const modal = document.getElementById('feedbackModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('feedbackContent').focus();
            }
        }

        async function submitFeedback() {
            const content = document.getElementById('feedbackContent').value.trim();
            const contact = document.getElementById('feedbackContact').value.trim();
            const btn = document.getElementById('feedbackSubmitBtn');

            if (!content) return showToast('è¯·è¾“å…¥åé¦ˆå†…å®¹');

            btn.disabled = true;
            btn.innerText = 'æäº¤ä¸­...';

            try {
                const { error } = await _supabase.from('feedbacks').insert([{
                    content,
                    contact,
                    client_id: clientId,
                    page_url: window.location.href,
                    module_name: 'çº¢åŒ…å£ä»¤'
                }]);

                if (error) throw error;

                showToast('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼');
                document.getElementById('feedbackContent').value = '';
                document.getElementById('feedbackContact').value = '';
                toggleFeedback();
            } catch (err) {
                console.error(err);
                showToast('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                btn.disabled = false;
                btn.innerText = 'æäº¤åé¦ˆ';
            }
        }

        // Usage Logic
        function toggleUsage() {
            document.getElementById('usageModal').classList.toggle('hidden');
        }

        function closeRecords() {
            document.getElementById('recordsModal').classList.add('hidden');
        }

        function handleSearch() {
            searchTerm = document.getElementById('searchTerm').value;
            renderPackets();
        }

        function setFilter(s) {
            filterStatus = s;
            ['active', 'all', 'completed', 'expired'].forEach(id => {
                const btn = document.getElementById('btn-' + id);
                if (id === s) {
                    btn.className = 'px-3 py-1.5 text-xs rounded-lg bg-gray-900 text-white transition-all';
                } else {
                    btn.className = 'px-3 py-1.5 text-xs rounded-lg text-gray-700 hover:bg-white transition-all';
                }
            });
            fetchPackets();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        }

        // Deep Link
        const params = new URLSearchParams(window.location.search);
        const targetId = params.get('id');
        if (targetId) {
            // Highlight or filter by targetId if needed
        }

        initCopyright();
        initAvatars();
        fetchPackets();
    </script>
</body>
</html>
