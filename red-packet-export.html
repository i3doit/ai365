<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢åŒ…å£ä»¤å·¥å…· - AI365</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down { animation: fadeInDown 0.3s ease-out forwards; }
        .line-clamp-4 { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">ğŸ§§ çº¢åŒ…å£ä»¤åŠ©åŠ›å·¥å…·</h1>
            <p class="mt-2 text-gray-500">åŒæ­¥åŠ©åŠ›å£ä»¤ï¼Œå¤§å®¶ä¸€èµ·é¢†ç¦åˆ©</p>
        </header>

        <!-- æäº¤è¡¨å• -->
        <section class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <span class="text-xl">âœï¸</span> å‘å¸ƒæ–°å£ä»¤
            </h2>
            <div class="space-y-4">
                <textarea id="content" placeholder="ç²˜è´´çº¢åŒ…å£ä»¤å†…å®¹... (ä¾‹å¦‚ï¼šå…ƒå®æ˜¥èŠ‚çº¢åŒ…...)" class="w-full h-32 p-4 rounded-2xl bg-gray-50 border-none focus:ring-2 focus:ring-blue-500 transition-all resize-none text-gray-700" required></textarea>
                <div class="flex flex-col md:flex-row gap-4">
                    <input id="creator" type="text" placeholder="ä½ çš„æ˜µç§°" value="è‰¾å…œå…œå„¿" class="flex-1 p-3 rounded-xl bg-gray-50 border-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <button id="submitBtn" onclick="submitPacket()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 active:scale-95 transition-all shadow-lg shadow-blue-200 disabled:opacity-50">
                        å‘å¸ƒåŠ©åŠ›
                    </button>
                </div>
            </div>
        </section>

        <!-- æœç´¢å’Œç­›é€‰ -->
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
            <div class="relative w-full md:w-64">
                <input id="search" oninput="handleSearch()" type="text" placeholder="æœç´¢å†…å®¹æˆ–å‘å¸ƒè€…..." class="w-full pl-10 pr-4 py-2 rounded-xl bg-white border border-gray-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <span class="absolute left-3 top-2.5 text-gray-400">ğŸ”</span>
            </div>
            <div class="flex bg-white rounded-xl p-1 border border-gray-100 shadow-sm">
                <button onclick="setFilter('active')" id="filter-active" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white">åŠ©æ‰‹ä¸­</button>
                <button onclick="setFilter('all')" id="filter-all" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-gray-500 hover:bg-gray-50">å…¨éƒ¨</button>
            </div>
        </div>

        <!-- å£ä»¤åˆ—è¡¨ -->
        <div id="packetList" class="grid gap-4 md:grid-cols-2">
            <div class="col-span-full py-12 text-center text-gray-400">æ­£åœ¨åŠ è½½å£ä»¤...</div>
        </div>

        <footer class="mt-12 py-8 border-t border-gray-200 text-center text-sm text-gray-500">
            <div class="mb-4 flex justify-center gap-4 flex-wrap px-4 text-xs text-gray-400">
                <a href="https://dkfile.com" target="_blank" class="hover:text-blue-600">DKFile.com</a>
                <a href="https://dkfile.xyz" target="_blank" class="hover:text-blue-600">DKFile.xyz</a>
                <a href="https://dkfile.istester.com" target="_blank" class="hover:text-blue-600">DKFile.istester.com</a>
                <a href="https://deepseek.idoxu.com" target="_blank" class="hover:text-blue-600">DeepSeek å®æˆ˜</a>
            </div>
            <p>Â© 2026 è‰¾å…œå…œå„¿ ç‰ˆæƒæ‰€æœ‰ Â· AI365</p>
            <p class="mt-2 flex justify-center gap-4">
                <a href="index-export.html" class="hover:text-blue-600">è¿”å›ä¸»é¡µ</a>
                <span>|</span>
                <a href="#" onclick="copyQQ()" class="hover:text-blue-600">å®˜æ–¹QQç¾¤: 857023577</a>
            </p>
        </footer>
    </div>

    <div id="toast" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="toastContent" class="bg-black/75 text-white px-6 py-3 rounded-2xl shadow-lg backdrop-blur-md text-sm font-medium animate-fade-in-down"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bmmtcrqvikvunvpsjjcx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtbXRjcnF2aWt2dW52cHNqamN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NDY4ODUsImV4cCI6MjA4MzUyMjg4NX0.RkaxCuNYHFtS7uDCsIpbZrQ2mheShQNkAHfXyxQGxK0';
        
        // é‡è¦ï¼šå¿…é¡»æŒ‡å®š schema ä¸º 'api'
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            db: { schema: 'api' }
        });

        let packets = [];
        let filter = 'active';
        let searchTerm = '';

        async function fetchPackets() {
            try {
                let query = _supabase.from('red_packets').select('*').order('created_at', { ascending: false });
                
                if (filter === 'active') {
                    query = query.eq('status', 'active').gt('remaining_copies', 0);
                }

                const { data, error } = await query;
                if (error) throw error;
                packets = data || [];
                renderPackets();
            } catch (err) {
                console.error('Fetch error:', err);
                showToast('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }
        }

        function renderPackets() {
            const listEl = document.getElementById('packetList');
            const filtered = packets.filter(p => 
                p.content.toLowerCase().includes(searchTerm.toLowerCase()) || 
                p.creator_name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="col-span-full py-12 text-center text-gray-400">æš‚æ— ç›¸å…³å£ä»¤</div>';
                return;
            }

            listEl.innerHTML = filtered.map(p => `
                <div class="group bg-white rounded-2xl p-5 border border-gray-100 hover:shadow-xl hover:shadow-gray-200/50 transition-all duration-300">
                    <div class="flex items-center gap-3 mb-4">
                        <img src="${p.creator_avatar || 'https://api.dicebear.com/7.x/identicon/svg?seed=' + encodeURIComponent(p.creator_name)}" class="w-10 h-10 rounded-full bg-gray-50 border border-gray-100 object-cover">
                        <div class="overflow-hidden">
                            <div class="font-semibold text-gray-900 text-sm truncate">${p.creator_name}</div>
                            <div class="text-[10px] text-gray-400">${new Date(p.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-3 text-gray-700 text-sm break-all font-mono mb-4 leading-relaxed line-clamp-4">
                        ${p.content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1.5 px-2.5 py-1 ${p.remaining_copies > 0 ? 'bg-amber-50 text-amber-700 border-amber-100' : 'bg-gray-100 text-gray-500 border-gray-200'} rounded-lg text-[11px] font-medium border">
                            <span>${p.remaining_copies > 0 ? 'ğŸ”¥' : 'âœ…'}</span> ${p.remaining_copies > 0 ? 'å‰©ä½™ ' + p.remaining_copies + ' æ¬¡' : 'å·²é¢†å®Œ'}
                        </div>
                        <button onclick="copyPacket('${p.id}', \`${p.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="px-4 py-1.5 bg-gray-900 text-white text-xs rounded-lg hover:bg-black transition-colors">
                            å¤åˆ¶å£ä»¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function submitPacket() {
            const content = document.getElementById('content').value.trim();
            const creator = document.getElementById('creator').value.trim();
            const btn = document.getElementById('submitBtn');

            if (!content) {
                showToast('è¯·è¾“å…¥å£ä»¤');
                return;
            }

            // æ”¾å®½é™åˆ¶ï¼šåªè¦é•¿åº¦è¶…è¿‡5ä¸”åŒ…å«åŸºæœ¬ç‰¹å¾ï¼Œæˆ–è€…ç”±ç”¨æˆ·ä¸»åŠ¨è¾“å…¥
            const text = content.toLowerCase();
            const isYuanbao = text.includes('å…ƒå®') || text.includes('å…ƒå¯¶') || text.includes('hu9190');
            if (content.length < 5) {
                showToast('å£ä»¤å†…å®¹å¤ªçŸ­äº†');
                return;
            }

            btn.disabled = true;
            btn.innerText = 'å‘å¸ƒä¸­...';

            try {
                const { error } = await _supabase.from('red_packets').insert([
                    { 
                        content, 
                        creator_name: creator || 'åŒ¿åç”¨æˆ·', 
                        creator_avatar: 'https://api.dicebear.com/7.x/identicon/svg?seed=' + encodeURIComponent(creator || 'anon'),
                        remaining_copies: 3,
                        status: 'active'
                    }
                ]);

                if (error) throw error;

                showToast('ğŸ‰ å‘å¸ƒæˆåŠŸï¼');
                document.getElementById('content').value = '';
                fetchPackets();
            } catch (err) {
                showToast('å‘å¸ƒå¤±è´¥: ' + (err.message || 'è¯·æ£€æŸ¥ç½‘ç»œ'));
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.innerText = 'å‘å¸ƒåŠ©åŠ›';
            }
        }

        async function copyPacket(id, content) {
            try {
                await navigator.clipboard.writeText(content);
                showToast('âœ… å£ä»¤å·²å¤åˆ¶');
                
                // ç®€å•çš„å‡å°‘æ¬¡æ•°é€»è¾‘ (è¿™é‡Œå¯ä»¥è°ƒç”¨ RPC æˆ–ç›´æ¥ update)
                // ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™é‡Œç›´æ¥å°è¯•å‡å°‘
                const { data: packet } = await _supabase.from('red_packets').select('remaining_copies').eq('id', id).single();
                if (packet && packet.remaining_copies > 0) {
                    const newCount = packet.remaining_copies - 1;
                    await _supabase.from('red_packets').update({ 
                        remaining_copies: newCount,
                        status: newCount === 0 ? 'completed' : 'active'
                    }).eq('id', id);
                    fetchPackets();
                }
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥');
            }
        }

        function handleSearch() {
            searchTerm = document.getElementById('search').value;
            renderPackets();
        }

        function setFilter(f) {
            filter = f;
            document.getElementById('filter-active').className = f === 'active' ? 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white' : 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-gray-500 hover:bg-gray-50';
            document.getElementById('filter-all').className = f === 'all' ? 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white' : 'px-4 py-1.5 rounded-lg text-sm font-medium transition-all text-gray-500 hover:bg-gray-50';
            fetchPackets();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            const content = document.getElementById('toastContent');
            content.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2000);
        }

        function copyQQ() {
            navigator.clipboard.writeText('857023577');
            showToast('QQç¾¤å·å·²å¤åˆ¶');
        }

        // åˆå§‹åŒ–
        fetchPackets();
    </script>
</body>
</html>